<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>소셜 로그인 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid #ccc;
            background: #f0f0f0;
        }

        .tab.active {
            background: #fff;
            border-bottom: none;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
            margin-top: 20px;
        }

        .kakao-btn {
            background-color: #FEE500;
            color: #000;
        }

                .apple-btn {
                    background-color: #000;
                    color: #fff;
                }
                .google-btn {
                    background-color: #4285F4;
                    color: #fff;
                }
            </style>
        </head>
        <body>
        
        <h1 style="text-align:center">소셜 로그인 테스트</h1>
        
        <div class="tabs">
            <div class="tab active" data-tab="kakao">카카오 로그인</div>
            <div class="tab" data-tab="apple">애플 로그인</div>
            <div class="tab" data-tab="google">구글 로그인</div>
        </div>
        
        <div class="tab-content active" id="kakao">
            <p style="text-align:center;">카카오 계정으로 로그인하려면 아래 버튼을 클릭하세요.</p>
            <div style="text-align:center;">
                <button id="kakao-login-btn" class="btn kakao-btn">카카오 로그인</button>
            </div>
        </div>
        
        <div class="tab-content" id="apple">
            <p style="text-align:center;">애플 계정으로 로그인하려면 아래 버튼을 클릭하세요.</p>
            <div style="text-align:center;">
                <button id="apple-login-btn" class="btn apple-btn">Apple 로그인</button>
            </div>
        </div>
        
        <div class="tab-content" id="google">
            <p style="text-align:center;">구글 계정으로 로그인하려면 아래 버튼을 클릭하세요.</p>
            <div style="text-align:center;">
                <button id="google-login-btn" class="btn google-btn">Google 로그인</button>
            </div>
        </div>
<!-- 결과 출력 -->
<pre id="result" style="margin-top: 30px; white-space: pre-wrap;"></pre>

<meta name="google-signin-client_id" content="">
<!-- Kakao SDK -->
<script src="https://developers.kakao.com/sdk/js/kakao.js"></script>

<!-- Apple SDK (실제 서비스용) -->
<script type="text/javascript"
        src="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js"></script>

<script>
    // Google Sign-In Callback (Global function)
    function onSignIn(googleUser) {
        var id_token = googleUser.getAuthResponse().id_token;
        fetch(`${API_SERVER}/api/v1/auth/signin`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                providerType: "GOOGLE",
                oauthToken: id_token
            })
        })
            .then(res => res.json())
            .then(data => {
                document.getElementById('result').textContent = 'Google 로그인 성공\n\nJWT: ' + data.accessToken;
            })
            .catch(err => {
                document.getElementById('result').textContent = 'Google 로그인 실패: ' + err.message;
            });
    }

    // 탭 전환
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));

            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        });
    });

    // Kakao init
    const KAKAO_JS_KEY = '';
    const API_SERVER = window.location.origin;

    Kakao.init(KAKAO_JS_KEY);

    document.getElementById('kakao-login-btn').addEventListener('click', () => {
        Kakao.Auth.login({
            scope: 'account_email,profile_nickname',
            success: function (authObj) {
                const accessToken = authObj.access_token;
                fetch(`${API_SERVER}/api/v1/auth/signin`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        providerType: "KAKAO",
                        oauthToken: accessToken
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('result').textContent = 'Kakao 로그인 성공\n\nJWT: ' + data.accessToken;
                    })
                    .catch(err => {
                        document.getElementById('result').textContent = 'Kakao 로그인 실패: ' + err.message;
                    });
            },
            fail: function (err) {
                document.getElementById('result').textContent = 'Kakao 로그인 실패: ' + JSON.stringify(err);
            }
        });
    });

    // Apple 로그인 - popup 모드
    document.getElementById('apple-login-btn').addEventListener('click', () => {
        AppleID.auth.init({
            clientId: '',
            scope: 'name email',
            redirectURI: `${window.location.origin}/kakao-login.html`,
            state: 'apple-login-' + Date.now(),
            responseType: 'code', // authorization code만 요청 (popup 모드에서 안정적)
            responseMode: 'query', // URL query parameter로 응답 받기
            usePopup: true
        });

        // Apple Sign In 실행
        AppleID.auth.signIn()
            .then(response => {
                console.log('Apple 로그인 성공:', response);
                
                const authorizationCode = response.authorization?.code;
                
                if (!authorizationCode) {
                    throw new Error('Authorization code not received from Apple');
                }

                const idToken = response.authorization?.id_token || 'popup-mode-token';

                const requestData = {
                    providerType: "APPLE",
                    oauthToken: idToken,
                    authorizationCode: authorizationCode
                };

                console.log('서버로 전송할 데이터:', requestData);

                return fetch(`${API_SERVER}/api/v1/auth/signin`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });
            })
            .then(async response => {
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(`서버 에러 (${response.status}): ${data.message || 'Unknown error'}`);
                }
                return data;
            })
            .then(data => {
                document.getElementById('result').textContent = 
                    'Apple 로그인 성공!\n\n' +
                    'JWT: ' + data.accessToken + '\n\n' +
                    '사용자 정보: ' + JSON.stringify(data.user || {}, null, 2);
            })
            .catch(error => {
                console.error('Apple 로그인 에러:', error);
                document.getElementById('result').textContent = 'Apple 로그인 실패: ' + error.message;
            });
    });

    // Apple 콜백 처리 (페이지 로드 시 URL 파라미터 확인)
    window.addEventListener('load', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        
        if (code && state && state.startsWith('apple-login-')) {
            console.log('Apple 콜백 감지됨:', { code, state });
            
            const requestData = {
                providerType: "APPLE",
                oauthToken: 'callback-id-token',
                authorizationCode: code
            };

            fetch(`${API_SERVER}/api/v1/auth/signin`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(requestData)
            })
                .then(async response => {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(`서버 에러 (${response.status}): ${data.message || 'Unknown error'}`);
                    }
                    return data;
                })
                .then(data => {
                    document.getElementById('result').textContent = 
                        'Apple 로그인 성공 (콜백)!\n\n' +
                        'JWT: ' + data.accessToken;
                        
                    history.replaceState({}, document.title, window.location.pathname);
                })
                .catch(error => {
                    console.error('Apple 콜백 처리 에러:', error);
                    document.getElementById('result').textContent = 'Apple 로그인 실패 (콜백): ' + error.message;
                });
        }
    });

    // Google Sign-In Initialization
    var GoogleAuth; // GoogleAuth object

    function initGoogleAuth() {
        gapi.client.init({
            clientId: document.querySelector('meta[name="google-signin-client_id"]').content,
            scope: 'profile email'
        }).then(function () {
            GoogleAuth = gapi.auth2.getAuthInstance();
            // Attach the click listener to the Google login button
            document.getElementById('google-login-btn').addEventListener('click', () => {
                GoogleAuth.signIn().then(onSignIn, (error) => {
                    console.error('Google Sign-In failed:', error);
                    document.getElementById('result').textContent = 'Google 로그인 실패: ' + JSON.stringify(error);
                });
            });
        });
    }

    function handleGoogleClientLoad() {
        gapi.load('client:auth2', initGoogleAuth);
    }
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleGoogleClientLoad();"></script>
</body>
</html>
